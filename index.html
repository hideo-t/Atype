<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å°±åŠ´ç¶™ç¶šæ”¯æ´Aå‹ å£²ä¸Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ 2024</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700;900&family=DM+Mono:wght@400;500&display=swap');

  :root {
    --bg: #0a0d14;
    --surface: #111620;
    --surface2: #1a2035;
    --border: #1e2d4a;
    --accent: #00d4ff;
    --accent2: #7c3aed;
    --accent3: #10b981;
    --warn: #f59e0b;
    --danger: #ef4444;
    --text: #e2e8f0;
    --muted: #64748b;
    --glow: 0 0 30px rgba(0,212,255,0.15);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Noto Sans JP', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    background-image: 
      radial-gradient(ellipse at 10% 0%, rgba(0,212,255,0.08) 0%, transparent 50%),
      radial-gradient(ellipse at 90% 100%, rgba(124,58,237,0.08) 0%, transparent 50%);
  }

  .header {
    padding: 28px 40px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 16px;
    backdrop-filter: blur(10px);
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(10,13,20,0.9);
  }

  .logo-icon {
    width: 44px; height: 44px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 22px;
  }

  .header-text h1 {
    font-size: 18px; font-weight: 700; letter-spacing: 0.02em;
  }
  .header-text p {
    font-size: 11px; color: var(--muted); letter-spacing: 0.1em;
    font-family: 'DM Mono', monospace;
  }

  .badge {
    margin-left: auto;
    background: linear-gradient(135deg, rgba(0,212,255,0.15), rgba(124,58,237,0.15));
    border: 1px solid rgba(0,212,255,0.3);
    color: var(--accent);
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 11px;
    font-family: 'DM Mono', monospace;
    letter-spacing: 0.1em;
  }

  .main {
    display: grid;
    grid-template-columns: 380px 1fr;
    gap: 0;
    min-height: calc(100vh - 81px);
  }

  .sidebar {
    border-right: 1px solid var(--border);
    padding: 28px;
    overflow-y: auto;
    background: var(--surface);
  }

  .content {
    padding: 28px;
    overflow-y: auto;
  }

  .section-title {
    font-size: 10px;
    letter-spacing: 0.15em;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    margin-bottom: 16px;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .section-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .form-group {
    margin-bottom: 20px;
  }

  label {
    display: block;
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 6px;
    letter-spacing: 0.05em;
  }

  select, input[type="number"], input[type="range"] {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 10px 14px;
    border-radius: 8px;
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s;
    appearance: none;
    -webkit-appearance: none;
  }
  select:focus, input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(0,212,255,0.1);
  }

  input[type="range"] {
    padding: 0;
    height: 6px;
    cursor: pointer;
    border-radius: 3px;
    accent-color: var(--accent);
  }

  .range-value {
    font-family: 'DM Mono', monospace;
    font-size: 20px;
    font-weight: 500;
    color: var(--accent);
    text-align: center;
    display: block;
    margin-top: 8px;
  }

  .addon-grid {
    display: grid;
    gap: 8px;
  }

  .addon-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 14px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 12px;
  }
  .addon-item:hover { border-color: rgba(0,212,255,0.3); }
  .addon-item.active {
    border-color: var(--accent);
    background: rgba(0,212,255,0.05);
  }

  .addon-item input[type="checkbox"] {
    width: auto;
    accent-color: var(--accent);
    margin: 0;
  }

  .addon-name { flex: 1; margin: 0 10px; }
  .addon-unit {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--accent3);
  }

  /* KPI Cards */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-bottom: 28px;
  }

  .kpi-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    position: relative;
    overflow: hidden;
    transition: transform 0.2s;
  }
  .kpi-card:hover { transform: translateY(-2px); }

  .kpi-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
  }
  .kpi-card.primary::before { background: linear-gradient(90deg, var(--accent), var(--accent2)); }
  .kpi-card.success::before { background: var(--accent3); }
  .kpi-card.warn::before { background: var(--warn); }

  .kpi-label {
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 0.08em;
    margin-bottom: 8px;
  }

  .kpi-value {
    font-family: 'DM Mono', monospace;
    font-size: 28px;
    font-weight: 500;
    line-height: 1;
    margin-bottom: 6px;
  }
  .kpi-card.primary .kpi-value { color: var(--accent); }
  .kpi-card.success .kpi-value { color: var(--accent3); }
  .kpi-card.warn .kpi-value { color: var(--warn); }

  .kpi-sub {
    font-size: 11px;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
  }

  .kpi-icon {
    position: absolute;
    top: 20px; right: 20px;
    font-size: 28px;
    opacity: 0.15;
  }

  /* Charts */
  .chart-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 28px;
  }

  .chart-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
  }

  .chart-title {
    font-size: 13px;
    font-weight: 500;
    margin-bottom: 20px;
    color: var(--text);
  }

  /* Breakdown table */
  .breakdown-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 16px;
  }

  .breakdown-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }
  .breakdown-table th {
    text-align: left;
    padding: 8px 12px;
    font-size: 10px;
    letter-spacing: 0.1em;
    color: var(--muted);
    border-bottom: 1px solid var(--border);
    font-family: 'DM Mono', monospace;
  }
  .breakdown-table td {
    padding: 10px 12px;
    border-bottom: 1px solid rgba(30,45,74,0.5);
    font-family: 'DM Mono', monospace;
  }
  .breakdown-table tr:last-child td { border-bottom: none; }
  .breakdown-table .total td {
    font-weight: 700;
    color: var(--accent);
    border-top: 1px solid var(--border);
    background: rgba(0,212,255,0.03);
  }
  .breakdown-table .name-col { 
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 12px;
  }
  .val-col { text-align: right; }
  .pct-col { text-align: right; color: var(--muted); font-size: 11px; }

  /* Scenario section */
  .scenario-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 28px;
  }

  .scenario-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
  }
  .scenario-card.best { border-color: var(--accent3); }
  .scenario-card.base { border-color: var(--accent); }
  .scenario-card.worst { border-color: var(--danger); }

  .scenario-label {
    font-size: 10px;
    letter-spacing: 0.1em;
    margin-bottom: 8px;
    font-family: 'DM Mono', monospace;
  }
  .scenario-card.best .scenario-label { color: var(--accent3); }
  .scenario-card.base .scenario-label { color: var(--accent); }
  .scenario-card.worst .scenario-label { color: var(--danger); }

  .scenario-rate {
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 4px;
  }
  .scenario-amount {
    font-family: 'DM Mono', monospace;
    font-size: 22px;
    font-weight: 500;
  }
  .scenario-card.best .scenario-amount { color: var(--accent3); }
  .scenario-card.base .scenario-amount { color: var(--accent); }
  .scenario-card.worst .scenario-amount { color: var(--danger); }

  .scenario-year {
    font-size: 11px;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    margin-top: 4px;
  }

  .tip-box {
    background: rgba(16,185,129,0.05);
    border: 1px solid rgba(16,185,129,0.2);
    border-radius: 12px;
    padding: 16px 20px;
    font-size: 12px;
    color: var(--accent3);
    margin-top: 16px;
    display: flex;
    gap: 10px;
    align-items: flex-start;
  }

  .tip-icon { font-size: 16px; flex-shrink: 0; }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .kpi-grid, .chart-grid, .scenario-grid, .breakdown-card {
    animation: fadeUp 0.4s ease both;
  }

  .divider { height: 1px; background: var(--border); margin: 24px 0; }

  .full-chart-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 28px;
  }

  select option { background: var(--surface2); }
</style>
</head>
<body>

<header class="header">
  <div class="logo-icon">ğŸ“Š</div>
  <div class="header-text">
    <h1>å°±åŠ´ç¶™ç¶šæ”¯æ´Aå‹ å£²ä¸Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
    <p>2024å¹´åº¦å ±é…¬æ”¹å®šå¯¾å¿œ Â· REVENUE FORECAST SYSTEM</p>
  </div>
  <span class="badge">2024 REVISED</span>
</header>

<div class="main">
  <!-- SIDEBAR -->
  <aside class="sidebar">

    <div class="section-title">åŸºæœ¬è¨­å®š</div>

    <div class="form-group">
      <label>äº‹æ¥­æ‰€ã®å®šå“¡æ•°</label>
      <select id="capacity" onchange="calc()">
        <option value="20">20äººä»¥ä¸‹</option>
        <option value="40" selected>21ã€œ40äºº</option>
        <option value="60">41ã€œ60äºº</option>
        <option value="80">61ã€œ80äºº</option>
        <option value="81">81äººä»¥ä¸Š</option>
      </select>
    </div>

    <div class="form-group">
      <label>å®Ÿéš›ã®å®šå“¡äººæ•°</label>
      <input type="number" id="actual_capacity" value="30" min="1" max="200" onchange="calc()">
    </div>

    <div class="form-group">
      <label>åŠ´åƒæ™‚é–“åŒºåˆ†</label>
      <select id="work_hours" onchange="calc()">
        <option value="1">â… ï¼š7æ™‚é–“30åˆ†ä»¥ä¸Š</option>
        <option value="2" selected>â…¡ï¼š6æ™‚é–“ä»¥ä¸Š7æ™‚é–“30åˆ†æœªæº€</option>
        <option value="3">â…¢ï¼š4æ™‚é–“ä»¥ä¸Š6æ™‚é–“æœªæº€</option>
        <option value="4">â…£ï¼š4æ™‚é–“æœªæº€</option>
      </select>
    </div>

    <div class="form-group">
      <label>åœ°åŸŸåŒºåˆ†ï¼ˆ1å˜ä½ã®å˜ä¾¡ï¼‰</label>
      <select id="region" onchange="calc()">
        <option value="11.40">1ç´šåœ°ï¼ˆ11.40å††ï¼‰â€” æ±äº¬23åŒºç­‰</option>
        <option value="11.12">2ç´šåœ°ï¼ˆ11.12å††ï¼‰</option>
        <option value="11.05">3ç´šåœ°ï¼ˆ11.05å††ï¼‰</option>
        <option value="10.84">4ç´šåœ°ï¼ˆ10.84å††ï¼‰</option>
        <option value="10.70">5ç´šåœ°ï¼ˆ10.70å††ï¼‰</option>
        <option value="10.42">6ç´šåœ°ï¼ˆ10.42å††ï¼‰</option>
        <option value="10.21">7ç´šåœ°ï¼ˆ10.21å††ï¼‰</option>
        <option value="10.00" selected>ãã®ä»–ï¼ˆ10.00å††ï¼‰</option>
      </select>
    </div>

    <div class="form-group">
      <label>æœˆé–“å–¶æ¥­æ—¥æ•°</label>
      <input type="number" id="working_days" value="22" min="15" max="27" onchange="calc()">
    </div>

    <div class="form-group">
      <label>å¹³å‡åˆ©ç”¨ç‡ï¼š<span id="rate_display">85</span>%</label>
      <input type="range" id="utilization" min="50" max="100" value="85" oninput="document.getElementById('rate_display').textContent=this.value; calc()">
    </div>

    <div class="divider"></div>
    <div class="section-title">åŠ ç®—è¨­å®š</div>

    <div class="addon-grid">
      <label class="addon-item" id="lbl_prof">
        <input type="checkbox" id="addon_prof1" onchange="toggleAddon('lbl_prof',this);calc()">
        <span class="addon-name">ç¦ç¥‰å°‚é–€è·å“¡é…ç½®åŠ ç®—â… </span>
        <span class="addon-unit">+15å˜ä½/æ—¥</span>
      </label>
      <label class="addon-item" id="lbl_prof2">
        <input type="checkbox" id="addon_prof2" onchange="toggleAddon('lbl_prof2',this);calc()">
        <span class="addon-name">ç¦ç¥‰å°‚é–€è·å“¡é…ç½®åŠ ç®—â…¡</span>
        <span class="addon-unit">+10å˜ä½/æ—¥</span>
      </label>
      <label class="addon-item" id="lbl_trans">
        <input type="checkbox" id="addon_trans" onchange="toggleAddon('lbl_trans',this);calc()">
        <span class="addon-name">å°±åŠ´ç§»è¡Œæ”¯æ´ä½“åˆ¶åŠ ç®—</span>
        <span class="addon-unit">+22å˜ä½/æ—¥</span>
      </label>
      <label class="addon-item" id="lbl_med">
        <input type="checkbox" id="addon_med" onchange="toggleAddon('lbl_med',this);calc()">
        <span class="addon-name">åŒ»ç™‚é€£æºä½“åˆ¶åŠ ç®—â… </span>
        <span class="addon-unit">+32å˜ä½/æ—¥</span>
      </label>
      <label class="addon-item" id="lbl_peer">
        <input type="checkbox" id="addon_peer" onchange="toggleAddon('lbl_peer',this);calc()">
        <span class="addon-name">ãƒ”ã‚¢ã‚µãƒãƒ¼ãƒˆå®Ÿæ–½åŠ ç®—</span>
        <span class="addon-unit">+100å˜ä½/æœˆ</span>
      </label>
      <label class="addon-item" id="lbl_absent">
        <input type="checkbox" id="addon_absent" checked onchange="toggleAddon('lbl_absent',this);calc()">
        <span class="addon-name">æ¬ å¸­æ™‚å¯¾å¿œåŠ ç®—</span>
        <span class="addon-unit">+94å˜ä½Ã—4å›</span>
      </label>
    </div>

    <div class="divider"></div>
    <div class="section-title">å‡¦é‡æ”¹å–„åŠ ç®—</div>

    <div class="form-group">
      <label>å‡¦é‡æ”¹å–„åŠ ç®—åŒºåˆ†</label>
      <select id="treatment" onchange="calc()">
        <option value="0">ãªã—ï¼ˆ0%ï¼‰</option>
        <option value="0.245" selected>åŠ ç®—â… ï¼ˆ24.5%ï¼‰</option>
        <option value="0.224">åŠ ç®—â…¡ï¼ˆ22.4%ï¼‰</option>
        <option value="0.178">åŠ ç®—â…¢ï¼ˆ17.8%ï¼‰</option>
        <option value="0.145">åŠ ç®—â…£ï¼ˆ14.5%ï¼‰</option>
      </select>
    </div>

  </aside>

  <!-- MAIN CONTENT -->
  <main class="content">

    <!-- KPI Cards -->
    <div class="kpi-grid">
      <div class="kpi-card primary">
        <div class="kpi-label">æœˆé–“å£²ä¸Šï¼ˆäºˆæ¸¬ï¼‰</div>
        <div class="kpi-value" id="kpi_month">â€”</div>
        <div class="kpi-sub" id="kpi_month_sub">â€”</div>
        <div class="kpi-icon">ğŸ’´</div>
      </div>
      <div class="kpi-card success">
        <div class="kpi-label">å¹´é–“å£²ä¸Šï¼ˆäºˆæ¸¬ï¼‰</div>
        <div class="kpi-value" id="kpi_year">â€”</div>
        <div class="kpi-sub" id="kpi_year_sub">â€”</div>
        <div class="kpi-icon">ğŸ“ˆ</div>
      </div>
      <div class="kpi-card warn">
        <div class="kpi-label">1äººã‚ãŸã‚Šæœˆé–“å˜ä¾¡</div>
        <div class="kpi-value" id="kpi_per_person">â€”</div>
        <div class="kpi-sub" id="kpi_base_unit">â€”</div>
        <div class="kpi-icon">ğŸ‘¤</div>
      </div>
    </div>

    <!-- Scenario -->
    <div class="section-title">åˆ©ç”¨ç‡ã‚·ãƒŠãƒªã‚ªæ¯”è¼ƒï¼ˆæœˆé–“ï¼‰</div>
    <div class="scenario-grid">
      <div class="scenario-card best">
        <div class="scenario-label">â–² BEST CASE</div>
        <div class="scenario-rate" id="sc_best_rate">â€”</div>
        <div class="scenario-amount" id="sc_best">â€”</div>
        <div class="scenario-year" id="sc_best_year">â€”</div>
      </div>
      <div class="scenario-card base">
        <div class="scenario-label">â—† BASE CASE</div>
        <div class="scenario-rate" id="sc_base_rate">â€”</div>
        <div class="scenario-amount" id="sc_base">â€”</div>
        <div class="scenario-year" id="sc_base_year">â€”</div>
      </div>
      <div class="scenario-card worst">
        <div class="scenario-label">â–¼ WORST CASE</div>
        <div class="scenario-rate" id="sc_worst_rate">â€”</div>
        <div class="scenario-amount" id="sc_worst">â€”</div>
        <div class="scenario-year" id="sc_worst_year">â€”</div>
      </div>
    </div>

    <!-- Charts -->
    <div class="chart-grid">
      <div class="chart-card">
        <div class="chart-title">åˆ©ç”¨ç‡åˆ¥ æœˆé–“å£²ä¸Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</div>
        <canvas id="chartLine" height="180"></canvas>
      </div>
      <div class="chart-card">
        <div class="chart-title">å£²ä¸Šå†…è¨³ï¼ˆæœˆé–“ï¼‰</div>
        <canvas id="chartDoughnut" height="180"></canvas>
      </div>
    </div>

    <!-- 12ãƒ¶æœˆè¦‹è¾¼ã¿ -->
    <div class="full-chart-card">
      <div class="chart-title">12ãƒ¶æœˆé–“ å£²ä¸Šè¦‹è¾¼ã¿ï¼ˆåˆ©ç”¨ç‡ã®æœˆåˆ¥å¤‰å‹•ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰</div>
      <canvas id="chartBar" height="100"></canvas>
    </div>

    <!-- Breakdown -->
    <div class="breakdown-card">
      <div class="section-title" style="margin-bottom:20px">å ±é…¬å†…è¨³ï¼ˆæœˆé–“ï¼‰</div>
      <table class="breakdown-table" id="breakdown_table">
        <thead>
          <tr>
            <th>é …ç›®</th>
            <th class="val-col">å˜ä½æ•°</th>
            <th class="val-col">é‡‘é¡ï¼ˆå††ï¼‰</th>
            <th class="pct-col">æ§‹æˆæ¯”</th>
          </tr>
        </thead>
        <tbody id="breakdown_body"></tbody>
      </table>
    </div>

    <div class="tip-box">
      <span class="tip-icon">ğŸ’¡</span>
      <div>
        <strong>çµŒå–¶ã®ãƒ’ãƒ³ãƒˆï¼š</strong>
        åˆ©ç”¨ç‡1%å‘ä¸Šã§æœˆé–“ç´„<span id="tip_amount">â€”</span>ã®å¢—åã«ãªã‚Šã¾ã™ã€‚
        åŠ ç®—ã®ç©æ¥µçš„ãªå–å¾—ã¨ã€æ¬ å¸­æ™‚å¯¾å¿œã®é©åˆ‡ãªè¨˜éŒ²ãŒå£²ä¸Šæœ€å¤§åŒ–ã®ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚
      </div>
    </div>

  </main>
</div>

<script>
// åŸºæœ¬å ±é…¬å˜ä½æ•°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ2024å¹´æ”¹å®šï¼‰
const BASE_UNITS = {
  20: { 1: 759, 2: 716, 3: 618, 4: 406 },
  40: { 1: 724, 2: 682, 3: 590, 4: 388 },
  60: { 1: 703, 2: 663, 3: 574, 4: 378 },
  80: { 1: 682, 2: 644, 3: 558, 4: 367 },
  81: { 1: 665, 2: 628, 3: 545, 4: 358 },
};

const MONTHS = ['4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ','1æœˆ','2æœˆ','3æœˆ'];

let lineChart, donutChart, barChart;

function toggleAddon(id, chk) {
  document.getElementById(id).classList.toggle('active', chk.checked);
}

function fmt(n) {
  if (n >= 10000000) return (n/10000000).toFixed(1)+'åƒä¸‡';
  if (n >= 1000000) return (n/1000000).toFixed(1)+'ç™¾ä¸‡';
  return n.toLocaleString('ja-JP');
}

function fmtFull(n) {
  return n.toLocaleString('ja-JP') + 'å††';
}

function calcRevenue(utilRate) {
  const cap = parseInt(document.getElementById('capacity').value);
  const actualCap = parseInt(document.getElementById('actual_capacity').value) || 30;
  const wh = parseInt(document.getElementById('work_hours').value);
  const region = parseFloat(document.getElementById('region').value);
  const days = parseInt(document.getElementById('working_days').value) || 22;
  const treatment = parseFloat(document.getElementById('treatment').value) || 0;

  // åŸºæœ¬å ±é…¬
  const baseUnit = BASE_UNITS[cap][wh];
  const users = Math.floor(actualCap * utilRate / 100);

  // æœˆé–“åŸºæœ¬å˜ä½
  let baseUnits = baseUnit * users * days;

  // åŠ ç®—ï¼ˆæ—¥å˜ä½ï¼‰
  let addonUnitsPerDay = 0;
  if (document.getElementById('addon_prof1').checked) addonUnitsPerDay += 15;
  if (document.getElementById('addon_prof2').checked) addonUnitsPerDay += 10;
  if (document.getElementById('addon_trans').checked) addonUnitsPerDay += 22;
  if (document.getElementById('addon_med').checked) addonUnitsPerDay += 32;

  const addonDailyTotal = addonUnitsPerDay * users * days;

  // åŠ ç®—ï¼ˆæœˆå˜ä½ï¼‰
  let addonMonthUnits = 0;
  if (document.getElementById('addon_peer').checked) addonMonthUnits += 100 * users;
  if (document.getElementById('addon_absent').checked) addonMonthUnits += 94 * 4; // æœˆ4å›ä¸Šé™

  const subtotalUnits = baseUnits + addonDailyTotal + addonMonthUnits;

  // å‡¦é‡æ”¹å–„åŠ ç®—ï¼ˆåŸºæœ¬å ±é…¬ï¼‹æ—¥å¸¸åŠ ç®—ã®åˆè¨ˆã«å¯¾ã—ã¦ï¼‰
  const treatmentUnits = Math.floor((baseUnits + addonDailyTotal) * treatment);

  const totalUnits = subtotalUnits + treatmentUnits;
  const totalYen = Math.floor(totalUnits * region);

  return {
    users, baseUnit, baseUnits, addonDailyTotal, addonMonthUnits,
    treatmentUnits, totalUnits, totalYen,
    region, days, actualCap
  };
}

function calc() {
  const utilRate = parseInt(document.getElementById('utilization').value);
  const r = calcRevenue(utilRate);

  // KPI
  document.getElementById('kpi_month').textContent = 'Â¥' + fmt(r.totalYen);
  document.getElementById('kpi_month_sub').textContent = r.users + 'äººåˆ©ç”¨ / ' + r.days + 'æ—¥';
  document.getElementById('kpi_year').textContent = 'Â¥' + fmt(r.totalYen * 12);
  document.getElementById('kpi_year_sub').textContent = 'æœˆé–“Ã—12ãƒ¶æœˆï¼ˆæ¦‚ç®—ï¼‰';
  const perPerson = r.users > 0 ? Math.floor(r.totalYen / r.users) : 0;
  document.getElementById('kpi_per_person').textContent = 'Â¥' + fmt(perPerson);
  document.getElementById('kpi_base_unit').textContent = 'åŸºæœ¬' + r.baseUnit + 'å˜ä½/æ—¥';

  // Scenarios
  const best = calcRevenue(Math.min(100, utilRate + 10));
  const worst = calcRevenue(Math.max(50, utilRate - 10));
  document.getElementById('sc_best_rate').textContent = 'åˆ©ç”¨ç‡ ' + Math.min(100, utilRate+10) + '%';
  document.getElementById('sc_best').textContent = 'Â¥' + fmt(best.totalYen);
  document.getElementById('sc_best_year').textContent = 'å¹´é–“ï¼šÂ¥' + fmt(best.totalYen*12);
  document.getElementById('sc_base_rate').textContent = 'åˆ©ç”¨ç‡ ' + utilRate + '%ï¼ˆç¾åœ¨ï¼‰';
  document.getElementById('sc_base').textContent = 'Â¥' + fmt(r.totalYen);
  document.getElementById('sc_base_year').textContent = 'å¹´é–“ï¼šÂ¥' + fmt(r.totalYen*12);
  document.getElementById('sc_worst_rate').textContent = 'åˆ©ç”¨ç‡ ' + Math.max(50, utilRate-10) + '%';
  document.getElementById('sc_worst').textContent = 'Â¥' + fmt(worst.totalYen);
  document.getElementById('sc_worst_year').textContent = 'å¹´é–“ï¼šÂ¥' + fmt(worst.totalYen*12);

  // Tip
  const diff1 = calcRevenue(Math.min(100, utilRate+1)).totalYen - r.totalYen;
  document.getElementById('tip_amount').textContent = fmtFull(diff1);

  // Breakdown table
  const total = r.totalYen;
  const rows = [
    { name: 'åŸºæœ¬å ±é…¬', units: r.baseUnits, yen: Math.floor(r.baseUnits * r.region) },
    { name: 'åŠ ç®—åˆè¨ˆï¼ˆæ—¥å˜ä½ï¼‰', units: r.addonDailyTotal, yen: Math.floor(r.addonDailyTotal * r.region) },
    { name: 'åŠ ç®—åˆè¨ˆï¼ˆæœˆå˜ä½ï¼‰', units: r.addonMonthUnits, yen: Math.floor(r.addonMonthUnits * r.region) },
    { name: 'å‡¦é‡æ”¹å–„åŠ ç®—', units: r.treatmentUnits, yen: Math.floor(r.treatmentUnits * r.region) },
  ];
  const tbody = document.getElementById('breakdown_body');
  tbody.innerHTML = '';
  rows.forEach(row => {
    if (row.units === 0) return;
    const pct = total > 0 ? (row.yen / total * 100).toFixed(1) : 0;
    tbody.innerHTML += `<tr>
      <td class="name-col">${row.name}</td>
      <td class="val-col">${row.units.toLocaleString()}</td>
      <td class="val-col">${row.yen.toLocaleString()}</td>
      <td class="pct-col">${pct}%</td>
    </tr>`;
  });
  tbody.innerHTML += `<tr class="total">
    <td class="name-col">åˆè¨ˆ</td>
    <td class="val-col">${r.totalUnits.toLocaleString()}</td>
    <td class="val-col">${r.totalYen.toLocaleString()}</td>
    <td class="pct-col">100%</td>
  </tr>`;

  // Charts
  updateCharts(utilRate, r);
}

function updateCharts(currentRate, r) {
  // Line chart: åˆ©ç”¨ç‡50ã€œ100%
  const rates = [];
  const amounts = [];
  for (let rate = 50; rate <= 100; rate += 5) {
    rates.push(rate + '%');
    amounts.push(calcRevenue(rate).totalYen);
  }

  if (lineChart) lineChart.destroy();
  lineChart = new Chart(document.getElementById('chartLine'), {
    type: 'line',
    data: {
      labels: rates,
      datasets: [{
        label: 'æœˆé–“å£²ä¸Š',
        data: amounts,
        borderColor: '#00d4ff',
        backgroundColor: 'rgba(0,212,255,0.1)',
        fill: true,
        tension: 0.4,
        pointBackgroundColor: amounts.map((_, i) => {
          const rate = 50 + i * 5;
          return rate === currentRate ? '#f59e0b' : '#00d4ff';
        }),
        pointRadius: amounts.map((_, i) => {
          const rate = 50 + i * 5;
          return rate === currentRate ? 8 : 3;
        }),
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => 'Â¥' + ctx.raw.toLocaleString('ja-JP')
          }
        }
      },
      scales: {
        y: {
          ticks: {
            color: '#64748b',
            callback: v => 'Â¥' + (v/10000).toFixed(0) + 'ä¸‡'
          },
          grid: { color: 'rgba(30,45,74,0.5)' }
        },
        x: {
          ticks: { color: '#64748b' },
          grid: { color: 'rgba(30,45,74,0.3)' }
        }
      }
    }
  });

  // Doughnut
  const baseYen = Math.floor(r.baseUnits * r.region);
  const addonYen = Math.floor((r.addonDailyTotal + r.addonMonthUnits) * r.region);
  const treatYen = Math.floor(r.treatmentUnits * r.region);
  const donutData = [baseYen, addonYen, treatYen].filter(v => v > 0);
  const donutLabels = ['åŸºæœ¬å ±é…¬', 'å„ç¨®åŠ ç®—', 'å‡¦é‡æ”¹å–„åŠ ç®—'].filter((_, i) => [baseYen, addonYen, treatYen][i] > 0);

  if (donutChart) donutChart.destroy();
  donutChart = new Chart(document.getElementById('chartDoughnut'), {
    type: 'doughnut',
    data: {
      labels: donutLabels,
      datasets: [{
        data: donutData,
        backgroundColor: ['#00d4ff', '#7c3aed', '#10b981'],
        borderColor: '#111620',
        borderWidth: 3,
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { color: '#94a3b8', font: { size: 11 } }
        },
        tooltip: {
          callbacks: {
            label: ctx => ctx.label + ': Â¥' + ctx.raw.toLocaleString('ja-JP')
          }
        }
      }
    }
  });

  // Bar chart: 12ãƒ¶æœˆï¼ˆå­£ç¯€å¤‰å‹•ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
  const seasonalRates = [currentRate-3, currentRate-2, currentRate+2, currentRate+1,
                         currentRate-5, currentRate-8, currentRate-2, currentRate,
                         currentRate+3, currentRate+2, currentRate-1, currentRate-3];
  const barData = seasonalRates.map(r2 => calcRevenue(Math.max(50, Math.min(100, r2))).totalYen);

  if (barChart) barChart.destroy();
  barChart = new Chart(document.getElementById('chartBar'), {
    type: 'bar',
    data: {
      labels: MONTHS,
      datasets: [{
        label: 'æœˆé–“å£²ä¸Š',
        data: barData,
        backgroundColor: barData.map((v, i) => {
          const max = Math.max(...barData);
          if (v === max) return 'rgba(16,185,129,0.8)';
          if (v === Math.min(...barData)) return 'rgba(239,68,68,0.6)';
          return 'rgba(0,212,255,0.6)';
        }),
        borderRadius: 6,
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => 'Â¥' + ctx.raw.toLocaleString('ja-JP')
          }
        }
      },
      scales: {
        y: {
          ticks: {
            color: '#64748b',
            callback: v => 'Â¥' + (v/10000).toFixed(0) + 'ä¸‡'
          },
          grid: { color: 'rgba(30,45,74,0.5)' }
        },
        x: {
          ticks: { color: '#64748b' },
          grid: { display: false }
        }
      }
    }
  });
}

// åˆæœŸåŒ–
window.onload = calc;
</script>
</body>
</html>
